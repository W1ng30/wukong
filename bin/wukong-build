#!/usr/bin/env node --harmony

/**
 *  Module dependencies.
 */

var program = require('commander'),
    fs = require('fs'),
    path = require('path')
    resolve = path.resolve,
    exists = fs.existsSync,
    Wukong = require('..'),
    utils = require('../lib/utils'),
    fatal = utils.fatal,
    log = utils.log;

// options

program
  .option('-c, --config <file>', 'Custom configuration file', 'wukong.json')
  .option('-s, --source <dir>', 'Source for the site', 'src')
  .option('-d, --dest <dir>', 'Output for the destination', 'build')
  .option('-t, --site <dir>', 'Specify the site directory', 'site')
  .option('-f, --force', 'Ignore cache, force build the site', false)
  .option('-v, --verbose', 'verbose output');

// examples

program.on('--help', function () {
  console.log('  Examples:');
  console.log();
  console.log('    # build to ./site');
  console.log('    $ wukong build');
  console.log();
});

// parse argv

program.parse(process.argv);

// wukong.json required!

var config = resolve(process.cwd(), program.config);

if (!exists(config)) fatal('Missing "wukong.json" configuration file.');

try {
  config = require(config);
} catch (e) {
  fatal('It seems like "wukong.json" is malformed.');
}

// Wukong

var wukong = Wukong(process.cwd());
// source
var source = config.source || program.source;
if (source) wukong.source(source);
// site
var site = config.site || program.site;
if (site) wukong.site(site);
// destination
var destination = config.destination || program.destination;
if (destination) wukong.destination(destination);
// metadata
var metadata = config.metadata || program.metadata;
if (metadata) wukong.metadata(metadata);

// Plugins.

var plugins = config['files-plugins'] || Object.create(null), key, plugin, opts;
for (key in plugins) {
  opts = plugins[key];

  try {
    plugin = require(key);
  } catch (e) {
    fatal('Failed to require plugin "' + key + '".');
  }

  wukong.useForFiles(plugin(opts));
}

plugins = config.plugins || Object.create(null);
for (key in plugins) {
  opts = plugins[key];

  try {
    plugin = require(key);
  } catch (e) {
    fatal('Failed to require plugin "' + key + '".');
  }

  wukong.use(plugin(opts));
}

// Build.

wukong.build(function *() {
  log('Successfully built to ' + wukong.destination());
  process.exit(0);
});
